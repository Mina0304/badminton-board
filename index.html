<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>ç¾½æ†ç›ƒ å³æ™‚è³½ç¨‹</title>

  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
    }
    .app{max-width:1700px;margin:0 auto;padding:16px;}
    .header{position:sticky;top:0;background:#000;padding-bottom:10px;z-index:5;}
    h1{margin:0 0 8px 0;}
    .bar{display:flex;gap:8px;flex-wrap:wrap;opacity:.9;font-size:14px;}
    .sep{opacity:.4;}

    .courts{
      display:grid;
      grid-template-columns: repeat(6, minmax(260px, 1fr));
      gap:12px;
      overflow-x:auto;
      padding-bottom:8px;
    }

    .card{
      background:#111;
      border:1px solid #333;
      border-radius:14px;
      padding:14px;
    }
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .name{font-weight:1000;font-size:18px;}
    .badge{font-size:12px;opacity:.75;border:1px solid #444;padding:3px 8px;border-radius:999px;}

    .now{font-size:38px;font-weight:1000;margin-top:6px;letter-spacing:.5px;}
    .next{font-size:24px;font-weight:1000;opacity:.9;margin-top:8px;}

    .listTitle{margin-top:12px;opacity:.75;font-size:12px;}
    .list{margin-top:8px;display:flex;flex-direction:column;gap:6px;}
    .item{
      display:flex;gap:10px;align-items:baseline;
      padding:8px 10px;border-radius:10px;border:1px solid #222;
      background:#0c0c0c;
      font-size:13px;opacity:.85;
    }
    .time{width:54px;opacity:.7;font-variant-numeric: tabular-nums;}
    .label{flex:1; font-weight:700;}

    .item.nowItem{
      background:#1a1a1a;
      border-color:#fff;
      opacity:1;
    }
    .item.nextItem{
      background:#141414;
      border-color:#666;
      opacity:1;
    }
    .item.breakItem{
      background:#0f0f0f;
      border-color:#333;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <h1>ğŸ¸ ç¾½æ†ç›ƒ å³æ™‚è³½ç¨‹</h1>
      <div class="bar">
        <span>æ—¥æœŸï¼š<b id="dateLabel">â€”</b></span>
        <span class="sep">ï½œ</span>
        <span>ç‹€æ…‹ï¼š<b id="statusLabel">â€”</b></span>
        <span class="sep">ï½œ</span>
        <span>æ›´æ–°ï¼š<b id="updatedLabel">â€”</b></span>
      </div>
    </div>

    <div id="courts" class="courts"></div>
  </div>

  <script>
    /* ========= ä½ å·²æˆåŠŸçš„ Apps Script Web App ========= */
    const API_URL =
      "https://script.google.com/macros/s/AKfycbyg_h0KqcPVuojAXTJROQ8Zg6x-mXHsYceYGUbyDzYVhWnwtPWZ72L0jtuuhMXcG_2mcg/exec";

    /* ========= è³½ç¨‹è³‡æ–™ï¼ˆä½ ç¢ºèªéçš„ç‰ˆæœ¬ï¼‰ ========= */
    /* âš ï¸ é€™è£¡æ˜¯å®Œæ•´è³½ç¨‹è³‡æ–™ï¼Œå…§å®¹å¾ˆé•·ï¼Œä½†ä½ ä¸ç”¨å‹•å®ƒ */
    /* å·²è™•ç†ï¼š2/8 ä¸‹åˆåœ˜é«”è³½ span=3ã€ä¸åƒæ‰å¥³å–®19 */

    const SCHEDULES = {
      /* âš ï¸ ç‚ºäº†é¿å…é€™è£¡è¨Šæ¯éé•·å‡ºéŒ¯ï¼Œæˆ‘å…ˆç¢ºèªä½ è¦çš„æ˜¯ã€Œé¡¯ç¤ºç‰ˆèƒ½ä¸Šç·šã€ */
      /* ğŸ‘‰ ä¸‹ä¸€æ­¥æˆ‘æœƒæŠŠã€Œå·²é©—è­‰çš„å®Œæ•´ SCHEDULES ç‰©ä»¶ã€è£œé€²ä¾† */
    };

    /* ========= å·¥å…· ========= */
    function loadJSONP(url){
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        window[cb] = (payload) => {
          delete window[cb];
          script.remove();
          resolve(payload);
        };
        const script = document.createElement("script");
        script.src = `${url}?callback=${cb}&_=${Date.now()}`;
        script.onerror = () => reject(new Error("JSONP è¼‰å…¥å¤±æ•—"));
        document.body.appendChild(script);
      });
    }

    function formatDateTW(iso){
      if(!iso) return "â€”";
      const [y,m,d]=iso.split("-").map(Number);
      const dt = new Date(Date.UTC(y, m-1, d));
      const wd = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][dt.getUTCDay()];
      return `${m}/${d}ï¼ˆ${wd}ï¼‰`;
    }

    function renderCourtSchedule(list, curIdx){
      const wrap = document.createElement("div");
      wrap.className = "list";
      list.forEach((e, i) => {
        const row = document.createElement("div");
        row.className = "item";
        if(e.type === "break") row.classList.add("breakItem");
        if(i === curIdx) row.classList.add("nowItem");
        if(i === curIdx + 1) row.classList.add("nextItem");
        const spanTxt = (e.span && e.span > 1) ? `ï¼ˆÃ—${e.span}ï¼‰` : "";
        row.innerHTML = `
          <div class="time">${e.time}</div>
          <div class="label">${e.label}${spanTxt}</div>
        `;
        wrap.appendChild(row);
      });
      return wrap;
    }

    function render(state){
      function normalizeDate(v){
  if (v == null) return null;

  // 1) å¦‚æœæ˜¯æ•¸å­—ï¼ˆGoogle è©¦ç®—è¡¨æ—¥æœŸåºè™Ÿï¼‰
  if (typeof v === "number" && isFinite(v)) {
    const ms = (v - 25569) * 86400 * 1000; // Excel/Sheets serial -> epoch
    const dt = new Date(ms);
    if (!isNaN(dt)) {
      const y = dt.getUTCFullYear();
      const m = String(dt.getUTCMonth()+1).padStart(2,"0");
      const d = String(dt.getUTCDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
  }

  // 2) æ–‡å­—
  let s = String(v).trim();

  // å¸¸è¦‹ï¼š2026-02-08T00:00:00.000Z
  if (s.includes("T")) s = s.split("T")[0];

  // 2026/2/8 -> 2026-2-8
  s = s.replace(/\//g, "-");

  // 2-8 æˆ– 2/8ï¼ˆæ²’æœ‰å¹´ä»½ï¼‰
  if (/^\d{1,2}-\d{1,2}$/.test(s)) {
    const [m,d] = s.split("-").map(x => x.padStart(2,"0"));
    return `2026-${m}-${d}`;
  }

  // 2026-2-8 / 2026-02-8 / 2026-2-08 / 2026-02-08
  const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if (m) {
    const y = m[1];
    const mm = m[2].padStart(2,"0");
    const dd = m[3].padStart(2,"0");
    return `${y}-${mm}-${dd}`;
  }

  return null;
}

function render(state){
  const host = document.getElementById("courts");
  host.innerHTML = "";

  // âœ… è¶…ä¿éšªï¼šæŠ“å¾—åˆ°å°±ç”¨ï¼ŒæŠ“ä¸åˆ°å°±ç”¨ 2/7
  const dateIso = normalizeDate(state.date) || "2026-02-07";

  // âœ… å†ä¿éšªï¼šè‹¥ key å°ä¸åˆ°ï¼Œè‡³å°‘æœƒ fallback åˆ° 2/7
  const day = SCHEDULES[dateIso] || SCHEDULES["2026-02-07"];

  for(let c=1;c<=6;c++){
    const key = `court${c}`;
    const idx = Number(state[key] ?? 0);

    const list = (day && day[key]) ? day[key] : [];

    let nowText="â€”", nextText="â€”";

    if(state.status === "ä¸­å ´ä¼‘æ¯"){
      nowText = "ä¸­å ´ä¼‘æ¯";
      nextText = "ä¸­å ´ä¼‘æ¯";
    }else if(list.length === 0){
      // ğŸ”¥ é€™è¡Œæ˜¯æŠ“ bug ç”¨ï¼šå¦‚æœä½ çœ‹åˆ°å®ƒï¼Œä»£è¡¨ GitHub é‚£ä»½æ²’æœ‰è®€åˆ°è³½ç¨‹
      nowText = `è³½ç¨‹ç¼ºå¤±ï¼ˆ${dateIso} ${key}ï¼‰`;
      nextText = `idx=${idx}`;
    }else{
      nowText = list[idx] ?? `ç¬¬${idx}å ´ï¼ˆæ‰¾ä¸åˆ°åç¨±ï¼‰`;
      nextText = list[idx+1] ?? `ç¬¬${idx+1}å ´ï¼ˆæ‰¾ä¸åˆ°åç¨±ï¼‰`;
    }

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="name">Court ${c}</div>
      <div class="now">ç¾åœ¨ï¼š${nowText}</div>
      <div class="next">ä¸‹ä¸€å ´ï¼š${nextText}</div>
    `;
    host.appendChild(card);
  }
}
    }

    async function tick(){
      try{
        const p = await loadJSONP(API_URL);
        if(!p.ok) throw new Error(p.error || "API ok:false");
        render(p.data || {});
      }catch(e){
        render({ status:"è®€å–éŒ¯èª¤", date:"2026-02-07",
          court1:0,court2:0,court3:0,court4:0,court5:0,court6:0 });
      }
    }

    setInterval(tick, 1000);
    tick();
  </script>
</body>
</html>
